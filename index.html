<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë ˆì‹œí”¼ ë§¤ë‹ˆì €</title>
  <style>
    :root {
      --bg-color: #e0e5ec;
      --main-color: #3498db;
      --shadow-light: #ffffff;
      --shadow-dark: #a3b1c6;
    }

    * {
      box-sizing: border-box;
      font-family: "Helvetica Neue", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg-color);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--bg-color);
      box-shadow: inset 5px 5px 10px var(--shadow-dark),
                  inset -5px -5px 10px var(--shadow-light);
      position: relative;
      z-index: 10;
    }

    .sidebar-button {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--bg-color);
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .program-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      flex-grow: 1;
      color: #333;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -400px;
      width: 150px;
      height: 100%;
      background: var(--bg-color);
      box-shadow: 10px 0 20px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .sidebar.show {
      left: 0;
    }

    .sidebar button {
      margin: 0.5rem 0;
      padding: 0.75rem;
      background: var(--bg-color);
      border: none;
      border-radius: 12px;
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
      font-size: 1rem;
      cursor: pointer;
      text-align: left;
    }

    main {
      padding: 1rem;
    }

    #content h2 {
      margin-top: 0;
    }

    .menu-description, .unit-settings {
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
      line-height: 1.6;
    }

    .menu-description strong {
      color: var(--main-color);
    }

    .unit-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .unit-item button {
      margin-left: 1rem;
      background: #f66;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
    }

    .unit-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .unit-input input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .unit-input button {
      background: var(--main-color);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    /* ì¬ë£Œ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
    .ingredients-container {
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
    }

    .ingredients-controls {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .ingredients-controls button {
      flex: 1 1 120px;
      padding: 0.5rem;
      background: var(--main-color);
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 3px 3px 6px var(--shadow-dark),
                  -3px -3px 6px var(--shadow-light);
      transition: background-color 0.2s ease;
    }
    .ingredients-controls button:hover {
      background: #217dbb;
    }

    /* ì¬ë£Œ ì¶”ê°€ í¼ */
    .ingredient-add-form {
      margin-bottom: 1rem;
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: inset 2px 2px 5px var(--shadow-light),
                  inset -2px -2px 5px var(--shadow-dark);
      display: none;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .ingredient-add-form.show {
      display: flex;
    }

    .ingredient-add-form label {
      flex: 1 0 70px;
      font-weight: 600;
      color: #444;
    }

    .ingredient-add-form input,
    .ingredient-add-form select {
      flex: 1 1 120px;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .ingredient-add-form button {
      flex: 1 1 120px;
      background: var(--main-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      box-shadow: 3px 3px 6px var(--shadow-dark),
                  -3px -3px 6px var(--shadow-light);
      transition: background-color 0.2s ease;
    }
    .ingredient-add-form button:hover {
      background: #217dbb;
    }

    /* ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */
    table.ingredients-table {
      width: 100%;
      table-layout: auto;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
    }

    table.ingredients-table thead {
      background: var(--main-color);
      color: white;
    }

    table.ingredients-table th,
    table.ingredients-table td {
      padding: 0.6rem 0.8rem;
      text-align: center;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }

    table.ingredients-table td button.delete-btn {
      background: #e74c3c;
      border: none;
      color: white;
      border-radius: 6px;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    table.ingredients-table td button.delete-btn:hover {
      background: #c0392b;
    }

    /* ì „ì²´ ì‚­ì œ í™•ì¸ */
    .confirm-delete-container {
      margin-top: 1rem;
      background: #fff3f3;
      border: 1px solid #e74c3c;
      color: #c0392b;
      padding: 1rem;
      border-radius: 12px;
      display: none;
      gap: 1rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .confirm-delete-container.show {
      display: flex;
    }

    .confirm-delete-container button {
      padding: 0.5rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .confirm-delete-container button.delete-confirm {
      background: #e74c3c;
      color: white;
    }

    .confirm-delete-container button.delete-cancel {
      background: #ccc;
      color: #333;
    }

    @media (max-width: 600px) {
      .program-title {
        font-size: 1.2rem;
      }

      .sidebar {
    width: 80%;
    left: -80%;
  }
  .sidebar.show {
    left: 0;
  }

      .ingredient-add-form,
  .editor-left,
  .editor-right {
    flex-direction: column;
    align-items: stretch;
  }

  .ingredient-row {
    flex-direction: column;
    align-items: flex-start;
  }

  .ingredient-row input,
  .ingredient-row select {
    width: 100%;
  }
      .ingredients-table {
    font-size: 0.85rem;
  }
    }
    .editor-container {
  display: flex;
  gap: 2rem;
  margin-top: 1rem;
}

.editor-left, .editor-right {
  flex: 1;
  background: var(--bg-color);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: inset 5px 5px 10px var(--shadow-dark),
              inset -5px -5px 10px var(--shadow-light);
}

.editor-right {
  flex: 3;
  background: var(--bg-color);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: inset 5px 5px 10px var(--shadow-dark),
              inset -5px -5px 10px var(--shadow-light);
}

.editor-header {
  display: flex;
  justify-content: flex-start;
  gap: 1rem;
  margin-bottom: 1rem;
}

.editor-input, .editor-textarea {
  width: 100%;
  padding: 0.6rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  border: none;
  box-shadow: inset 3px 3px 6px var(--shadow-dark),
              inset -3px -3px 6px var(--shadow-light);
  background: var(--bg-color);
  resize: vertical;
}

.btn-main {
  background: var(--main-color);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 0.6rem 1.2rem;
  box-shadow: 3px 3px 6px var(--shadow-dark),
              -3px -3px 6px var(--shadow-light);
  cursor: pointer;
}

.btn-sub {
  background: var(--bg-color);
  color: #333;
  border: none;
  border-radius: 10px;
  padding: 0.5rem 1rem;
  box-shadow: 3px 3px 6px var(--shadow-dark),
              -3px -3px 6px var(--shadow-light);
  cursor: pointer;
}

.section-container {
  margin-top: 1rem;
}

.preview-card {
  background: #fff;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 5px 5px 10px var(--shadow-dark),
              -5px -5px 10px var(--shadow-light);
  overflow-x: auto;
  font-size: 0.9rem;
}

.recipe-section {
  background: #f9f9f9;
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 12px;
  box-shadow: inset 3px 3px 6px var(--shadow-light),
              inset -3px -3px 6px var(--shadow-dark);
}

.ingredient-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
  align-items: center;
}
.preview-card table {
  width: auto;
  border-collapse: collapse;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 3px 3px 8px var(--shadow-dark),
              -3px -3px 8px var(--shadow-light);
  font-size: 0.9rem;
  margin-top: 1rem;
}

.preview-card thead {
  background: var(--main-color);
  color: #333;
}

.preview-card th,
.preview-card td {
  padding: 0.6rem 0.8rem;
  text-align: center;
  border-bottom: 1px solid #ddd;
  vertical-align: middle;
}

.preview-card th:first-child,
.preview-card td:first-child {
  border-left: none;
}

.preview-card tr:last-child td {
  border-bottom: none;
}

.preview-card tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}

.prep-action-btn {
  background: var(--bg-color);
  border: none;
  border-radius: 8px;
  padding: 0.3rem 0.6rem;
  margin: 0 0.2rem;
  cursor: pointer;
  box-shadow: 2px 2px 5px var(--shadow-dark),
              -2px -2px 5px var(--shadow-light);
  transition: all 0.2s ease;
}

.prep-action-btn:hover {
  background: #d0d8e0;
  transform: translateY(-1px);
}

/* í”„ë© í…Œì´ë¸” ì—´ ë„ˆë¹„ ì¤„ì´ê¸° */
table.ingredients-table th.small-col,
table.ingredients-table td.small-col {
  width: 60px;
  min-width: 50px;
  padding: 0.3rem 0.4rem;
}

table.ingredients-table th.small-coll,
table.ingredients-table td.small-coll {
  width: 60px;
  min-width: 50px;
  padding: 0.3rem 0.4rem;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-box {
  background: #fff;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  text-align: center;
  max-width: 400px;
  width: 90%;
}

.modal-actions {
  margin-top: 1rem;
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.modal-actions button {
  padding: 0.5rem 1.5rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

#modalConfirmBtn {
  background-color: #e74c3c;
  color: #fff;
}

#modalCancelBtn {
  background-color: #ccc;
  color: #333;
}


  </style>
</head>
<body>
  <header>
    <div class="sidebar-button" onclick="toggleSidebar()">â˜°</div>
    <div class="program-title">ë ˆì‹œí”¼ ë§¤ë‹ˆì €</div>
  </header>

  <div id="sidebar" class="sidebar">
    <button onclick="openMenu('home')">í™ˆ</button>
    <button onclick="openMenu('prep')">í”„ë©</button>
    <button onclick="openMenu('recipe')">ë ˆì‹œí”¼</button>
    <button onclick="openMenu('ingredients')">ì¬ë£Œ</button>
    <button onclick="openMenu('settings')">ì„¤ì •</button>
    <button onclick="openMenu('convert')">ì»¨ë²„íŠ¸</button>
    <hr />
    <button onclick="exportAllData()">ì „ì²´ ë‚´ë³´ë‚´ê¸°</button>
    <button onclick="importAllData()">ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <main>
    <div id="content">ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
  </main>
  
  <!-- ê³µìš© ëª¨ë‹¬ -->
<div id="globalModal" class="modal-overlay" style="display: none;">
  <div class="modal-box">
    <p id="modalMessage">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="modal-actions">
      <button id="modalConfirmBtn">ì‚­ì œ</button>
      <button id="modalCancelBtn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

  
<datalist id="ingredientNamesList"></datalist>

  <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ CDN -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


  <script>
    const unitList = ["g", "kg", "ml", "L", "ê°œ", "ë§ˆë¦¬", "ì¤„ê¸°"];

    let ingredients = [];

    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('show');
    }

    // ë©”ë‰´ ì˜¤í”ˆ í•¨ìˆ˜
    function openMenu(menuName) {
      const content = document.getElementById('content');
      document.getElementById('sidebar').classList.remove('show');;

      let html = '';
      switch (menuName) {
        case 'home':
          html = `
            <h2>í™ˆ - ê¸°ëŠ¥ ì„¤ëª…ì„œ</h2>
            <div class="menu-description">
              <p><strong>í”„ë©</strong>: ì‘ì—… ì „ ì¤€ë¹„ ê³¼ì •ì„ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
              <p><strong>ë ˆì‹œí”¼</strong>: ìš”ë¦¬ ë ˆì‹œí”¼ë¥¼ ë“±ë¡í•˜ê³  í•„ìš”í•œ ì¬ë£Œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>
              <p><strong>ì¬ë£Œ</strong>: ì¬ë£Œ ëª©ë¡ê³¼ ë‹¨ê°€ ë“±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
              <p><strong>ì„¤ì •</strong>: ë‹¨ìœ„ ì„¤ì • ë“± í™˜ê²½ ì„¤ì •ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              <p><strong>ì»¨ë²„íŠ¸</strong>: ë‹¨ìœ„ ë³€í™˜ ë° ë°ì´í„° ë³€í™˜ì„ ì§€ì›í•©ë‹ˆë‹¤.</p>
            </div>`;
          break;

        case 'settings':
          html = `
            <h2>ì„¤ì • - ë‹¨ìœ„ ê´€ë¦¬</h2>
            <div class="unit-settings">
              <div id="unit-list"></div>
              <div class="unit-input">
                <input type="text" id="newUnit" placeholder="ìƒˆ ë‹¨ìœ„ ì…ë ¥" />
                <button onclick="addUnit()">ì €ì¥</button>
              </div>
            </div>`;
          break;

        case 'ingredients':
          html = renderIngredientsMenuHTML();
          break;

		case 'recipe':
  html = renderRecipeMenuHTML();
  setTimeout(() => renderRecipeList(), 0);  // ë Œë” í›„ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
  break;

case 'prep':
  html = renderPrepMenuHTML();
  setTimeout(() => renderPrepList(), 0);
  break;

case 'convert':
  html = `
    <h2>ì»¨ë²„íŠ¸ ë©”ë‰´</h2>
    <div class="ingredients-container">
      <div class="ingredients-controls">
        <button onclick="openRecipeSelector()">ë ˆì‹œí”¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="exportRecipePdf()">PDFë¡œ ì €ì¥</button>
      </div>
      <div class="preview-card" id="convertPreview"></div>
    </div>
  `;
  break;


        default:
          html = `<h2>${menuName}</h2><p>${menuName} ê´€ë ¨ ê¸°ëŠ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
      }

      content.innerHTML = html;

      if (menuName === 'settings') {
        renderUnitList();
      } else if (menuName === 'ingredients') {
        renderUnitListForIngredients();
        renderIngredientsTable();
        attachIngredientFormEvents();
      }
    }

    // ë‹¨ìœ„ ëª©ë¡ ë Œë”ë§ (ì„¤ì • ë©”ë‰´)
    function renderUnitList() {
      const list = document.getElementById("unit-list");
      list.innerHTML = '';
      unitList.forEach((unit, index) => {
        const item = document.createElement("div");
        item.className = "unit-item";
        item.innerHTML = `${unit} <button onclick="deleteUnit(${index})">ì‚­ì œ</button>`;
        list.appendChild(item);
      });
    }

    // ë‹¨ìœ„ ëª©ë¡ ë Œë”ë§ (ì¬ë£Œ ë©”ë‰´ - ë‹¨ìœ„ select ë°•ìŠ¤ìš©)
    function renderUnitListForIngredients() {
      const select = document.getElementById("ingredientUnit");
      if (!select) return;
      select.innerHTML = '';
      unitList.forEach(u => {
        const option = document.createElement("option");
        option.value = u;
        option.textContent = u;
        select.appendChild(option);
      });
    }

    function addUnit() {
      const input = document.getElementById("newUnit");
      const newUnit = input.value.trim();
      if (newUnit === '') {
        alert("ë‹¨ìœ„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      if (unitList.includes(newUnit)) {
        alert("ì´ë¯¸ ë“±ë¡ëœ ë‹¨ìœ„ì…ë‹ˆë‹¤.");
        return;
      }
      unitList.push(newUnit);
      input.value = '';
      renderUnitList();
    }

    function deleteUnit(index) {
      if (confirm(`ë‹¨ìœ„ "${unitList[index]}" ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        unitList.splice(index, 1);
        renderUnitList();
      }
    }

    // ì¬ë£Œ ë©”ë‰´ HTML ë°˜í™˜
    function renderIngredientsMenuHTML() {
      return `
        <h2>ì¬ë£Œ ê´€ë¦¬</h2>
        <div class="ingredients-container">

          <div class="ingredients-controls">
            <button id="btnAddIngredient">ì¬ë£Œ ì¶”ê°€</button>
            <button id="btnExportIngredients">ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
            <button id="btnImportIngredients">ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="btnClearIngredients">ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ ì „ì²´ ì‚­ì œ</button>
          </div>

          <form id="ingredientAddForm" class="ingredient-add-form" onsubmit="return false;">
            <label for="ingredientCategory">ë¶„ë¥˜</label>
            <input type="text" id="ingredientCategory" placeholder="ë¶„ë¥˜ ì…ë ¥" />

            <label for="ingredientName">ì¬ë£Œëª…<span style="color:#e74c3c">*</span></label>
            <input type="text" id="ingredientName" placeholder="ì¬ë£Œëª… ì…ë ¥ (í•„ìˆ˜)" required />

            <label for="ingredientPrice">ì¬ë£Œ ê°€ê²©</label>
            <input type="number" id="ingredientPrice" min="0" placeholder="ìˆ«ìë§Œ ì…ë ¥" />

            <label for="ingredientQuantity">ì¬ë£Œ ìˆ˜ëŸ‰</label>
            <input type="number" id="ingredientQuantity" min="0" step="any" placeholder="ìˆ«ìë§Œ ì…ë ¥" />

            <label for="ingredientUnit">ë‹¨ìœ„</label>
            <select id="ingredientUnit"></select>

            <button id="btnRegisterIngredient" type="submit">ì¬ë£Œ ë“±ë¡</button>
          </form>

          <table class="ingredients-table" id="ingredientsTable" border="1" cellspacing="0" cellpadding="4">
            <thead>
              <tr>
                <th>ë¶„ë¥˜</th>
                <th>ì¬ë£Œëª…</th>
                <th>ì¬ë£Œ ê°€ê²©</th>
                <th>ì¬ë£Œ ìˆ˜ëŸ‰</th>
                <th>ë‹¨ìœ„</th>
                <th>ì¬ë£Œ ë‹¨ê°€</th>
                <th>ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

         
        </div>
      `;
    }
    
    function renderPrepMenuHTML() {
  return `
    <h2>í”„ë© ê´€ë¦¬</h2>
    <div class="ingredients-container">
      <div class="ingredients-controls">
        <button onclick="togglePrepForm()">í”„ë© ì¶”ê°€</button>
        <button onclick="exportPrepExcel()">í”„ë© ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="importPrepExcel()">í”„ë© ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="confirmClearPrepList()">í”„ë© ë¦¬ìŠ¤íŠ¸ ì „ì²´ ì‚­ì œ</button>
      </div>

      <form id="prepForm" class="ingredient-add-form" style="display:none;" onsubmit="return false;">
  <label for="prepName">ìš”ë¦¬ëª…</label>
  <input type="text" id="prepName" placeholder="ìš”ë¦¬ëª… ì…ë ¥" required />

  <label for="prepText">í”„ë©</label>
  <textarea id="prepText" placeholder="í”„ë© ì…ë ¥"></textarea>

  <button onclick="savePrep()">í”„ë© ì €ì¥</button>
</form>

      </form>

      <table class="ingredients-table">
        <thead>
          <tr>
            <th style="white-space: nowrap;">ìš”ë¦¬ëª…</th>
            <th>í”„ë©</th>
            <th>ìˆœì„œ</th>
            <th>ìˆ˜ì •</th>
            <th>ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="prepListBody"></tbody>
      </table>

      
    </div>
  `;
}

    
    function renderRecipeMenuHTML() {
  return `
    <h2>ë ˆì‹œí”¼ ë©”ë‰´</h2>
    <div class="ingredients-container">
      <div class="ingredients-controls">
        <button onclick="openRecipeEditor()">ë ˆì‹œí”¼ ì¶”ê°€</button>
        <button onclick="importRecipeExcel()">ë ˆì‹œí”¼ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <table class="ingredients-table" id="recipeTable">
        <thead>
          <tr>
            <th>ìš”ë¦¬ëª…</th>
            <th>ìƒì„¸ë³´ê¸°</th>
            <th>ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</th>
            <th>ìˆ˜ì •</th>
            <th>ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="recipeListBody"></tbody>
      </table>
    </div>
  `;
}
let recipes = [];

let preps = [];

function togglePrepForm() {
  const form = document.getElementById('prepForm');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

function savePrep() {
  const name = document.getElementById('prepName').value.trim();
  const text = document.getElementById('prepText').value.trim();

  if (!name) {
    alert('ìš”ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const existing = preps.findIndex(p => p.name === name);
  if (existing !== -1) {
    if (!confirm(`"${name}" í”„ë©ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    preps[existing] = { name, text };
  } else {
    preps.push({ name, text });
  }

  document.getElementById('prepName').value = '';
  document.getElementById('prepText').value = '';
  togglePrepForm();
  renderPrepList();
}

function renderPrepList() {
  const tbody = document.getElementById('prepListBody');
  tbody.innerHTML = '';

  preps.forEach((prep, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
  <td style="white-space: nowrap;">${prep.name}</td>
  <td style="white-space:pre-line;">${prep.text}</td>
  <td class="small-col">
    <button class="prep-action-btn" onclick="movePrep(${i}, -1)">â¬†</button>
    <button class="prep-action-btn" onclick="movePrep(${i}, 1)">â¬‡</button>
  </td>
  <td class="small-col">
    <button class="prep-action-btn" onclick="editPrep(${i})">âœï¸</button>
  </td>
  <td class="small-col">
    <button class="prep-action-btn" onclick="confirmDeletePrep(${i})">ğŸ—‘ï¸</button>
  </td>
`;

    tbody.appendChild(row);
  });
}

function editPrep(index) {
  const prep = preps[index];
  document.getElementById('prepName').value = prep.name;
  document.getElementById('prepText').value = prep.text;
  togglePrepForm();
}

function movePrep(index, direction) {
  const target = index + direction;
  if (target < 0 || target >= preps.length) return;
  [preps[index], preps[target]] = [preps[target], preps[index]];
  renderPrepList();
}

function confirmDeletePrep(index) {
  if (confirm(`"${preps[index].name}" í”„ë©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    preps.splice(index, 1);
    renderPrepList();
  }
}


function renderRecipeList() {
  const tbody = document.getElementById('recipeListBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  recipes.forEach((recipe, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${recipe.name}</td>
      <td><button class="prep-action-btn" onclick="viewRecipeDetail(${index})">ìƒì„¸ë³´ê¸°</button></td>
      <td><button class="prep-action-btn" onclick="exportRecipeExcel(${index})">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button></td>
      <td><button class="prep-action-btn" onclick="editRecipe(${index})">ìˆ˜ì •</button></td>
      <td><button class="prep-action-btn" onclick="confirmDeleteRecipe(${index})">ì‚­ì œ</button></td>
    `;
    tbody.appendChild(tr);
  });
}


    // ì¬ë£Œ ë‹¨ê°€ ê³„ì‚° í•¨ìˆ˜
    function calcUnitPrice(price, quantity, unit) {
      if (!price || price <= 0 || !quantity || quantity <= 0) return '';
      let adjustedQuantity = quantity;
      if (unit === 'kg' || unit === 'L') {
        adjustedQuantity = quantity * 1000;
      }
      return (price / adjustedQuantity).toFixed(2);
    }

    // ì¬ë£Œ ë“±ë¡ ì²˜ë¦¬
    function registerIngredient() {
      const category = document.getElementById('ingredientCategory').value.trim();
      const name = document.getElementById('ingredientName').value.trim();
      const priceRaw = document.getElementById('ingredientPrice').value.trim();
      const quantityRaw = document.getElementById('ingredientQuantity').value.trim();
      const unit = document.getElementById('ingredientUnit').value;

      if (name === '') {
        alert("ì¬ë£Œëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        return;
      }

      if (ingredients.some(i => i.name === name)) {
        alert("ì¤‘ë³µë˜ëŠ” ì¬ë£Œëª…ì´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const price = priceRaw === '' ? 0 : parseFloat(priceRaw);
      const quantity = quantityRaw === '' ? 0 : parseFloat(quantityRaw);

      const unitPrice = calcUnitPrice(price, quantity, unit);

      ingredients.push({
        category,
        name,
        price,
        quantity,
        unit,
        unitPrice,
      });

      clearIngredientForm();
      renderIngredientsTable();
    }

    // ì¬ë£Œ ì¶”ê°€ í¼ ì´ˆê¸°í™”
    function clearIngredientForm() {
      document.getElementById('ingredientCategory').value = '';
      document.getElementById('ingredientName').value = '';
      document.getElementById('ingredientPrice').value = '';
      document.getElementById('ingredientQuantity').value = '';
      document.getElementById('ingredientUnit').selectedIndex = 0;
    }

    // ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” ë Œë”ë§
    function renderIngredientsTable() {
      const tbody = document.querySelector('#ingredientsTable tbody');
      tbody.innerHTML = '';

      ingredients.forEach((ing, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ing.category}</td>
          <td>${ing.name}</td>
          <td>${ing.price || ''}</td>
          <td>${ing.quantity || ''}</td>
          <td>${ing.unit}</td>
          <td>${ing.unitPrice}</td>
          <td><button class="delete-btn" onclick="deleteIngredient(${index})">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ì¬ë£Œ ì‚­ì œ
    function deleteIngredient(index) {
      if (confirm(`"${ingredients[index].name}" ì¬ë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        ingredients.splice(index, 1);
        renderIngredientsTable();
      }
    }

    // ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
    function exportIngredientsExcel() {
      if (ingredients.length === 0) {
        alert("ë‚´ë³´ë‚¼ ì¬ë£Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // ì›Œí¬ë¶ê³¼ ì›Œí¬ì‹œíŠ¸ ìƒì„±
      const wb = XLSX.utils.book_new();

      // ì¬ë£Œ ë°ì´í„°ë¥¼ ì‹œíŠ¸ìš© ë°°ì—´ë¡œ ë³€í™˜
      const data = [
        ["ë¶„ë¥˜", "ì¬ë£Œëª…", "ì¬ë£Œ ê°€ê²©", "ì¬ë£Œ ìˆ˜ëŸ‰", "ë‹¨ìœ„", "ì¬ë£Œ ë‹¨ê°€"],
      ];
      ingredients.forEach(ing => {
        data.push([
          ing.category,
          ing.name,
          ing.price,
          ing.quantity,
          ing.unit,
          ing.unitPrice
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "ì¬ë£Œë¦¬ìŠ¤íŠ¸");

      // ì—‘ì…€ íŒŒì¼ ìƒì„±
      XLSX.writeFile(wb, "ì¬ë£Œë¦¬ìŠ¤íŠ¸.xlsx");
    }

    // ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°
    function importIngredientsExcel() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = ".xlsx, .xls";
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = evt => {
          const data = new Uint8Array(evt.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const wsName = wb.SheetNames[0];
          const ws = wb.Sheets[wsName];
          const importedData = XLSX.utils.sheet_to_json(ws, { header: 1 });

          // ì²« í–‰ì€ í—¤ë”
          const header = importedData[0];
          if (!header || header.length < 6) {
            alert("ì—‘ì…€ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }

          // ë‚˜ë¨¸ì§€ í–‰ ë°ì´í„°
          const rows = importedData.slice(1).filter(r => r.length > 0);

          // ì¤‘ë³µ ì¬ë£Œëª… ì²´í¬
          let duplicates = [];
          for (let row of rows) {
            const name = row[1];
            if (ingredients.some(i => i.name === name)) {
              duplicates.push(name);
            }
          }

          // ë®ì–´ì“°ê¸° ì—¬ë¶€ í™•ì¸
          if (duplicates.length > 0) {
            const overwrite = confirm(`ì¤‘ë³µë˜ëŠ” ì¬ë£Œëª…(${duplicates.join(", ")})ì´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (í™•ì¸: ë®ì–´ì“°ê¸°, ì·¨ì†Œ: ìœ ì§€)`);
            rows.forEach(row => {
              const obj = {
                category: row[0] || '',
                name: row[1] || '',
                price: parseFloat(row[2]) || 0,
                quantity: parseFloat(row[3]) || 0,
                unit: row[4] || '',
                unitPrice: '',
              };
              obj.unitPrice = calcUnitPrice(obj.price, obj.quantity, obj.unit);

              if (obj.name === '') return; // ì´ë¦„ ì—†ìœ¼ë©´ ìŠ¤í‚µ

              const existingIndex = ingredients.findIndex(i => i.name === obj.name);
              if (existingIndex !== -1) {
                if (overwrite) {
                  ingredients[existingIndex] = obj;
                }
              } else {
                ingredients.push(obj);
              }
            });
          } else {
            // ì¤‘ë³µ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¶”ê°€
            rows.forEach(row => {
              const obj = {
                category: row[0] || '',
                name: row[1] || '',
                price: parseFloat(row[2]) || 0,
                quantity: parseFloat(row[3]) || 0,
                unit: row[4] || '',
                unitPrice: '',
              };
              obj.unitPrice = calcUnitPrice(obj.price, obj.quantity, obj.unit);

              if (obj.name === '') return;

              ingredients.push(obj);
            });
          }

          renderIngredientsTable();
        };
        reader.readAsArrayBuffer(file);
      };
      input.click();
    }

    // ì „ì²´ ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ - í™•ì¸ UI ë„ìš°ê¸°
    function clearIngredientsWithConfirm() {
  showModal("ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
    ingredients = [];
    renderIngredientsTable();
  });
}


    // ì‚­ì œ í™•ì¸ ì·¨ì†Œ
    function cancelClearIngredients() {
      const confirmBox = document.getElementById('confirmDeleteContainer');
      confirmBox.classList.remove('show');
    }

    // ì‚­ì œ í™•ì¸ í›„ ì‹¤ì œ ì‚­ì œ
    function confirmClearIngredients() {
      ingredients = [];
      renderIngredientsTable();
      cancelClearIngredients();
    }

    // ì¬ë£Œ ì¶”ê°€ í¼ ì´ë²¤íŠ¸ ì—°ê²°
    function attachIngredientFormEvents() {
      document.getElementById('btnAddIngredient').onclick = () => {
        const form = document.getElementById('ingredientAddForm');
        form.classList.toggle('show');
      };
      document.getElementById('btnRegisterIngredient').onclick = registerIngredient;
      document.getElementById('btnExportIngredients').onclick = exportIngredientsExcel;
      document.getElementById('btnImportIngredients').onclick = importIngredientsExcel;
      document.getElementById('btnClearIngredients').onclick = clearIngredientsWithConfirm;
      document.getElementById('confirmDeleteBtn').onclick = confirmClearIngredients;
      document.getElementById('cancelDeleteBtn').onclick = cancelClearIngredients;
    }

    // ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ìë¦¬ í‘œì‹œì (ì¶”í›„ í™•ì¥ ê°€ëŠ¥)
    function exportAllData() {
  const wb = XLSX.utils.book_new();

  // í”„ë© ì‹œíŠ¸
  const prepSheet = XLSX.utils.json_to_sheet(preps);
  XLSX.utils.book_append_sheet(wb, prepSheet, 'í”„ë©');

  // ë ˆì‹œí”¼ ì‹œíŠ¸ (JSON ë¬¸ìì—´í™”)
  const recipeJson = recipes.map(r => [JSON.stringify(r)]);
  const recipeSheet = XLSX.utils.aoa_to_sheet([["ë ˆì‹œí”¼ JSON"]].concat(recipeJson));
  XLSX.utils.book_append_sheet(wb, recipeSheet, 'ë ˆì‹œí”¼');

  // ì¬ë£Œ ì‹œíŠ¸
  const ingredientSheet = XLSX.utils.json_to_sheet(ingredients);
  XLSX.utils.book_append_sheet(wb, ingredientSheet, 'ì¬ë£Œ');

  // ë‹¨ìœ„ ì‹œíŠ¸
  const unitSheet = XLSX.utils.aoa_to_sheet([["ë‹¨ìœ„ ë¦¬ìŠ¤íŠ¸"], ...unitList.map(u => [u])]);
  XLSX.utils.book_append_sheet(wb, unitSheet, 'ë‹¨ìœ„');

  XLSX.writeFile(wb, 'ì „ì²´_ë°ì´í„°.xlsx');
}


    function importAllData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = ".xlsx, .xls";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = evt => {
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type: 'array' });

      // í”„ë©
      const prepRows = XLSX.utils.sheet_to_json(wb.Sheets['í”„ë©'] || {}, { header: 1 });
      preps = prepRows.slice(1).map(([name, text]) => ({ name, text }));

      // ë ˆì‹œí”¼
      const recipeRows = XLSX.utils.sheet_to_json(wb.Sheets['ë ˆì‹œí”¼'] || {}, { header: 1 });
      recipes = recipeRows.slice(1).map(row => {
        try {
          return JSON.parse(row[0]);
        } catch (e) {
          return null;
        }
      }).filter(r => r !== null);

      // ì¬ë£Œ
      const ingredientRows = XLSX.utils.sheet_to_json(wb.Sheets['ì¬ë£Œ'] || {}, { header: 1 });
      ingredients = ingredientRows.slice(1).map(([category, name, price, quantity, unit, unitPrice]) => ({
        category,
        name,
        price,
        quantity,
        unit,
        unitPrice
      }));

      // ë‹¨ìœ„
      const unitRows = XLSX.utils.sheet_to_json(wb.Sheets['ë‹¨ìœ„'] || {}, { header: 1 });
      unitList.length = 0; // ê¸°ì¡´ ë‹¨ìœ„ ì´ˆê¸°í™”
      unitRows.slice(1).forEach(row => {
        if (row[0]) unitList.push(row[0]);
      });

      renderPrepList();
      renderRecipeList();
      renderIngredientsTable();
    };
    reader.readAsArrayBuffer(file);
  };

  input.click();
}


    
    let recipeSectionIndex = 0;

function addRecipeSection() {
  const container = document.getElementById('recipeSections');
  const sectionId = `section-${recipeSectionIndex++}`;
  const section = document.createElement('div');
  section.className = 'recipe-section';
  section.dataset.id = sectionId;

  section.innerHTML = `
    <hr />
    <label>ë¶„ë¥˜ëª…</label><br/>
    <input type="text" class="section-name" placeholder="ì˜ˆ: ì†ŒìŠ¤, ë³¸ì²´ ë“±" style="width: 100%;" /><br/><br/>
    <label>ì†Œë¶„ ìˆ˜ëŸ‰</label><br/>
    <input type="number" class="portion-quantity" placeholder="ì˜ˆ: 10" style="width: 100%;" /><br/><br/>
    <button class="prep-action-btn" onclick="addIngredientToSection('${sectionId}')">ì¬ë£Œ ì¶”ê°€</button>
    <button class="prep-action-btn" onclick="removeRecipeSection(this)">ë¶„ë¥˜ ì¶”ê°€ ì·¨ì†Œ</button>
    <div class="ingredients-in-section"></div>
  `;
  container.appendChild(section);
  
  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bindPreviewEventsToElement(section.querySelector('.section-name'));
  bindPreviewEventsToElement(section.querySelector('.portion-quantity'));

  renderRecipePreview()
}
function removeRecipeSection(btn) {
  const section = btn.closest('.recipe-section');
  section.remove();
}
function addIngredientToSection(sectionId) {
  const section = document.querySelector(`.recipe-section[data-id="${sectionId}"] .ingredients-in-section`);
  const ingDiv = document.createElement('div');
  ingDiv.className = 'ingredient-row';
  ingDiv.style.marginBottom = '1rem';

  ingDiv.innerHTML = `
    <label>ì¬ë£Œëª…</label>
    <input type="text" class="ingredient-name" style="width: 150px;" onblur="populateIngredientInfo(this)" />

    <label>ì‚¬ìš©ëŸ‰</label>
    <input type="number" class="ingredient-amount" style="width: 80px;" />

    <label>ë‹¨ìœ„</label>
    <select class="ingredient-unit" style="width: 80px;">
      ${unitList.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
    </select>

    <button class="prep-action-btn" onclick="removeIngredient(this)">ì¬ë£Œ ì¶”ê°€ ì·¨ì†Œ</button>

    <div class="ingredient-info" style="font-size: 0.9em; color: #666; margin-top: 4px;"></div>
  `;
  section.appendChild(ingDiv);

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bindPreviewEventsToElement(ingDiv.querySelector('.ingredient-name'));
  bindPreviewEventsToElement(ingDiv.querySelector('.ingredient-amount'));
  bindPreviewEventsToElement(ingDiv.querySelector('.ingredient-unit'));

  renderRecipePreview();
}

function removeIngredient(btn) {
  const row = btn.closest('.ingredient-row');
  row.remove();
}
function populateIngredientInfo(input) {
  const name = input.value.trim();
  const infoBox = input.parentElement.querySelector('.ingredient-info');
  const found = ingredients.find(i => i.name === name);
  if (found) {
    infoBox.innerHTML = `ìˆ˜ëŸ‰: ${found.quantity}, ë‹¨ìœ„: ${found.unit}, ê°€ê²©: ${found.price}, ë‹¨ê°€: ${found.unitPrice}`;
  } else {
    infoBox.innerHTML = `<span style="color:red;">ë“±ë¡ë˜ì§€ ì•Šì€ ì¬ë£Œì…ë‹ˆë‹¤.</span>`;
  }
}
function renderRecipePreview() {
  const name = document.getElementById('recipeName').value.trim();
  const price = parseFloat(document.getElementById('recipePrice').value) || 0;

  const sectionElements = document.querySelectorAll('.recipe-section');

  let totalCost = 0;
  const sectionData = [];

  sectionElements.forEach(section => {
    const sectionName = section.querySelector('.section-name').value.trim();
    const portionQtyRaw = section.querySelector('.portion-quantity').value.trim();
    const portionQty = portionQtyRaw === '' ? null : parseFloat(portionQtyRaw);
    const ingredients = section.querySelectorAll('.ingredient-row');

    const ingList = [];
    let sectionUsageSum = 0;
    let sectionCostSum = 0;

    ingredients.forEach(ing => {
      const ingName = ing.querySelector('.ingredient-name').value.trim();
      const amount = parseFloat(ing.querySelector('.ingredient-amount').value) || 0;
      const unit = ing.querySelector('.ingredient-unit').value;
      const ingMeta = getIngredientMeta(ingName);

      let usedUnitPrice = 0;
      if (ingMeta) {
        usedUnitPrice = unit === 'kg' || unit === 'L'
          ? ingMeta.unitPrice * (amount * 1000)
          : ingMeta.unitPrice * amount;
      }

      sectionUsageSum += amount;
      sectionCostSum += usedUnitPrice;

      ingList.push({
        name: ingName,
        amount,
        unit,
        usedUnitPrice: usedUnitPrice.toFixed(2),
        ...ingMeta
      });
    });

    let sectionSubtotal = 0;

if (portionQty === null || portionQty === '' || isNaN(portionQty)) {
  // ì†Œë¶„ ìˆ˜ëŸ‰ì´ ì—†ì„ ê²½ìš° â†’ ì‚¬ìš© ë‹¨ê°€ í•©ê³„ë§Œ ì¶œë ¥
  sectionSubtotal = sectionCostSum;
} else {
  // ì†Œë¶„ ìˆ˜ëŸ‰ì´ ìˆëŠ” ê²½ìš° â†’ (ë‹¨ê°€ í•©ê³„ Ã· ì‚¬ìš©ëŸ‰ í•©ê³„) Ã— ì†Œë¶„ ìˆ˜ëŸ‰
  if (sectionUsageSum > 0) {
    sectionSubtotal = (sectionCostSum / sectionUsageSum) * portionQty;
  }
}



    totalCost += sectionSubtotal;

    sectionData.push({
      name: sectionName,
      portionQty,
      ingredients: ingList,
      subtotal: sectionSubtotal.toFixed(2)
    });
  });

  const costRatio = price > 0 ? ((totalCost / price) * 100).toFixed(1) + "%" : "-";

  let html = `
    <p><strong>ìš”ë¦¬ëª…:</strong> ${name}</p>
    <p><strong>ì´ì›ê°€:</strong> ${totalCost.toFixed(2)} ì›</p>
    <p><strong>íŒë§¤ê°€:</strong> ${price} ì›</p>
    <p><strong>ì›ê°€ìœ¨:</strong> ${costRatio}</p>
    <table border="1" cellspacing="0" cellpadding="4" style="width:100%; font-size:0.9em; border-collapse: collapse; background: #fff;">
      <thead style="background:#f0f0f0;">
        <tr>
          <th>ë¶„ë¥˜ëª…</th>
          <th>ì¬ë£Œëª…</th>
          <th>ì‚¬ìš©ëŸ‰</th>
          <th>ì‚¬ìš© ë‹¨ìœ„</th>
          <th>ì‚¬ìš© ë‹¨ê°€</th>
          <th>ì¬ë£Œ ìˆ˜ëŸ‰</th>
          <th>ì¬ë£Œ ë‹¨ìœ„</th>
          <th>ì¬ë£Œ ê°€ê²©</th>
          <th>ì¬ë£Œ ë‹¨ê°€</th>
          <th>ì†Œë¶„ ìˆ˜ëŸ‰</th>
          <th>ì†Œê³„</th>
        </tr>
      </thead>
      <tbody>
  `;

  sectionData.forEach(sec => {
    sec.ingredients.forEach((ing, idx) => {
      html += `
        <tr>
          ${idx === 0 ? `<td rowspan="${sec.ingredients.length}">${sec.name}</td>` : ''}
          <td>${ing.name}</td>
          <td>${ing.amount}</td>
          <td>${ing.unit}</td>
          <td>${ing.usedUnitPrice}</td>
          <td>${ing.quantity || ''}</td>
          <td>${ing.unit || ''}</td>
          <td>${ing.price || ''}</td>
          <td>${ing.unitPrice || ''}</td>
          ${idx === 0 ? `<td rowspan="${sec.ingredients.length}">${sec.portionQty ?? ''}</td>` : ''}
          ${idx === 0 ? `<td rowspan="${sec.ingredients.length}">${sec.subtotal}</td>` : ''}
        </tr>
      `;
    });
  });

  html += `</tbody></table>`;

  document.getElementById('recipePreview').innerHTML = html;
}
function getIngredientMeta(name) {
  const found = ingredients.find(i => i.name === name);
  return found ? { ...found } : {};
}
function saveRecipe(editIndex = null) {
  const name = document.getElementById('recipeName').value.trim();
  const price = parseFloat(document.getElementById('recipePrice').value) || 0;
  const steps = document.getElementById('recipeSteps').value.trim();
  const memo = document.getElementById('recipeMemo').value.trim();

  if (!name) {
    alert('ìš”ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const sections = [];
  const sectionElements = document.querySelectorAll('.recipe-section');
  sectionElements.forEach(section => {
    const sectionName = section.querySelector('.section-name').value.trim();
    const portionQtyRaw = section.querySelector('.portion-quantity').value.trim();
    const portionQty = portionQtyRaw === '' ? null : parseFloat(portionQtyRaw);

    const ingredients = [];
    section.querySelectorAll('.ingredient-row').forEach(row => {
      const ingName = row.querySelector('.ingredient-name').value.trim();
      const amount = parseFloat(row.querySelector('.ingredient-amount').value) || 0;
      const unit = row.querySelector('.ingredient-unit').value;

      ingredients.push({ name: ingName, amount, unit });
    });

    sections.push({ sectionName, portionQty, ingredients });
  });

  const recipeObj = {
    name,
    price,
    steps,
    memo,
    sections
  };

  if (editIndex !== null && recipes[editIndex]) {
    recipes[editIndex] = recipeObj;
  } else {
    recipes.push(recipeObj);
  }

  openMenu('recipe');
  renderRecipeList();
}
function editRecipe(index) {
  const recipe = recipes[index];
  openRecipeEditor(index);

  setTimeout(() => {
    document.getElementById('recipeName').value = recipe.name;
    document.getElementById('recipePrice').value = recipe.price;
    document.getElementById('recipeSteps').value = recipe.steps || '';
    document.getElementById('recipeMemo').value = recipe.memo || '';

    recipe.sections.forEach(section => {
      addRecipeSection();
      const latestSection = document.querySelector('.recipe-section:last-child');
      latestSection.querySelector('.section-name').value = section.sectionName;
      if (section.portionQty !== null) {
        latestSection.querySelector('.portion-quantity').value = section.portionQty;
      }

      section.ingredients.forEach(ing => {
        addIngredientToSection(latestSection.dataset.id);
        const latestIng = latestSection.querySelector('.ingredient-row:last-child');
        latestIng.querySelector('.ingredient-name').value = ing.name;
        latestIng.querySelector('.ingredient-amount').value = ing.amount;
        latestIng.querySelector('.ingredient-unit').value = ing.unit;
        populateIngredientInfo(latestIng.querySelector('.ingredient-name'));
      });
    });

    renderRecipePreview();
  }, 0);
}
function editRecipe(index) {
  const recipe = recipes[index];
  openRecipeEditor(index);

  setTimeout(() => {
    document.getElementById('recipeName').value = recipe.name;
    document.getElementById('recipePrice').value = recipe.price;
    document.getElementById('recipeSteps').value = recipe.steps || '';
    document.getElementById('recipeMemo').value = recipe.memo || '';

    recipe.sections.forEach(section => {
      addRecipeSection();
      const latestSection = document.querySelector('.recipe-section:last-child');
      latestSection.querySelector('.section-name').value = section.sectionName;
      if (section.portionQty !== null) {
        latestSection.querySelector('.portion-quantity').value = section.portionQty;
      }

      section.ingredients.forEach(ing => {
        addIngredientToSection(latestSection.dataset.id);
        const latestIng = latestSection.querySelector('.ingredient-row:last-child');
        latestIng.querySelector('.ingredient-name').value = ing.name;
        latestIng.querySelector('.ingredient-amount').value = ing.amount;
        latestIng.querySelector('.ingredient-unit').value = ing.unit;
        populateIngredientInfo(latestIng.querySelector('.ingredient-name'));
      });
    });

    renderRecipePreview();
  }, 0);
}
function exportRecipeExcel(index) {
  const recipe = recipes[index];
  if (!recipe) return;

  const data = [
    ["ìš”ë¦¬ëª…", recipe.name],
    ["íŒë§¤ê°€", recipe.price],
    [],
    ["í”Œë ˆì´íŒ… ìˆœì„œ", recipe.steps],
    [],
    ["ë©”ëª¨", recipe.memo],
    [],
    ["ë¶„ë¥˜ëª…", "ì†Œë¶„ ìˆ˜ëŸ‰", "ì¬ë£Œëª…", "ì‚¬ìš©ëŸ‰", "ë‹¨ìœ„"]
  ];

  recipe.sections.forEach(sec => {
    sec.ingredients.forEach((ing, i) => {
      data.push([
        i === 0 ? sec.sectionName : "",
        i === 0 ? (sec.portionQty ?? "") : "",
        ing.name,
        ing.amount,
        ing.unit
      ]);
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, recipe.name);
  XLSX.writeFile(wb, `${recipe.name}_ë ˆì‹œí”¼.xlsx`);
}
function confirmDeleteRecipe(index) {
  const recipe = recipes[index];
  if (!recipe) return;

  const ok = confirm(`"${recipe.name}" ë ˆì‹œí”¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
  if (ok) {
    recipes.splice(index, 1);
    renderRecipeList();
  }
}
function importRecipeExcel() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = ".xlsx, .xls";
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const wsName = wb.SheetNames[0];
      const ws = wb.Sheets[wsName];
      const sheetData = XLSX.utils.sheet_to_json(ws, { header: 1 });

      if (sheetData.length < 8) {
        alert("ì—‘ì…€ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const name = sheetData[0][1] || "ì œëª© ì—†ìŒ";
      const price = parseFloat(sheetData[1][1]) || 0;
      const steps = (sheetData[3] || [])[1] || '';
      const memo = (sheetData[5] || [])[1] || '';

      const recipeSections = [];
      let currentSection = null;

      for (let i = 8; i < sheetData.length; i++) {
        const row = sheetData[i];
        const sectionName = row[0] || (currentSection ? '' : null);
        const portionQty = row[1] !== '' ? parseFloat(row[1]) : null;
        const ingredientName = row[2];
        const amount = parseFloat(row[3]) || 0;
        const unit = row[4];

        if (!ingredientName) continue;

        if (sectionName !== '') {
          currentSection = {
            sectionName,
            portionQty,
            ingredients: []
          };
          recipeSections.push(currentSection);
        }

        currentSection.ingredients.push({
          name: ingredientName,
          amount,
          unit
        });
      }

      const newRecipe = {
        name,
        price,
        steps,
        memo,
        sections: recipeSections
      };

      const existingIndex = recipes.findIndex(r => r.name === name);
      if (existingIndex !== -1) {
        const overwrite = confirm(`"${name}" ë ˆì‹œí”¼ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (overwrite) {
          recipes[existingIndex] = newRecipe;
        }
      } else {
        recipes.push(newRecipe);
      }

      openMenu('recipe');
      renderRecipeList();
    };

    reader.readAsArrayBuffer(file);
  };

  input.click();
}
function bindPreviewEventsToElement(element) {
  if (!element) return;
  element.addEventListener('input', renderRecipePreview);
  element.addEventListener('change', renderRecipePreview);
  element.addEventListener('blur', renderRecipePreview);
}
function removeRecipeSection(btn) {
  const section = btn.closest('.recipe-section');
  section.remove();
  renderRecipePreview();
}

function removeIngredient(btn) {
  const row = btn.closest('.ingredient-row');
  row.remove();
  renderRecipePreview();
}
function viewRecipeDetail(index) {
  const recipe = recipes[index];
  if (!recipe) {
    alert('ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="editor-container">
      <div class="editor-left">
        <h2>${recipe.name}</h2>
        <p><strong>íŒë§¤ê°€:</strong> ${recipe.price || '-'} ì›</p>
        <p><strong>í”Œë ˆì´íŒ… ìˆœì„œ:</strong><br/>${(recipe.steps || '').replace(/\n/g, '<br/>')}</p>
        <p><strong>ë©”ëª¨:</strong><br/>${(recipe.memo || '').replace(/\n/g, '<br/>')}</p>
        <button class="btn-sub" onclick="openMenu('recipe')">ëŒì•„ê°€ê¸°</button>
        <button class="btn-sub" onclick="editRecipe(${index})">ìˆ˜ì •</button>
      </div>
      <div class="editor-right">
        <h3>ì„œë¥˜ ë¯¸ë¦¬ë³´ê¸°</h3>
        <div id="recipePreview" class="preview-card"></div>
      </div>
    </div>
  `;

  // ì—ë””í„°ê°€ ì•„ë‹Œ, ì˜¤ë¥¸ìª½ ë¯¸ë¦¬ë³´ê¸°ë§Œ ë Œë”ë§
  renderRecipePreviewFromData(recipe);
}
function renderRecipePreviewFromData(recipe) {
  const sectionData = [];
  let totalCost = 0;

  recipe.sections.forEach(sec => {
    let sectionCostSum = 0;
    let sectionUsageSum = 0;
    const ingList = [];

    sec.ingredients.forEach(ing => {
      const meta = getIngredientMeta(ing.name);
      const amount = ing.amount || 0;
      let usedUnitPrice = 0;

      if (meta.unitPrice) {
        usedUnitPrice = ing.unit === 'kg' || ing.unit === 'L'
          ? meta.unitPrice * (amount * 1000)
          : meta.unitPrice * amount;
      }

      sectionCostSum += usedUnitPrice;
      sectionUsageSum += amount;

      ingList.push({
        ...meta,
        name: ing.name,
        amount,
        unit: ing.unit,
        usedUnitPrice: usedUnitPrice.toFixed(2),
      });
    });

    let subtotal = 0;
    const portionQty = sec.portionQty;

    if (portionQty === null || portionQty === '' || isNaN(portionQty)) {
      subtotal = sectionCostSum;
    } else if (sectionUsageSum > 0) {
      subtotal = (sectionCostSum / sectionUsageSum) * portionQty;
    }

    totalCost += subtotal;

    sectionData.push({
      name: sec.sectionName,
      portionQty,
      ingredients: ingList,
      subtotal: subtotal.toFixed(2),
    });
  });

  const costRatio = recipe.price > 0 ? ((totalCost / recipe.price) * 100).toFixed(1) + "%" : "-";

  let html = `
    <p><strong>ìš”ë¦¬ëª…:</strong> ${recipe.name}</p>
    <p><strong>ì´ì›ê°€:</strong> ${totalCost.toFixed(2)} ì›</p>
    <p><strong>íŒë§¤ê°€:</strong> ${recipe.price} ì›</p>
    <p><strong>ì›ê°€ìœ¨:</strong> ${costRatio}</p>
    <table class="preview-table">
      <thead>
        <tr>
          <th>ë¶„ë¥˜ëª…</th>
          <th>ì¬ë£Œëª…</th>
          <th>ì‚¬ìš©ëŸ‰</th>
          <th>ë‹¨ìœ„</th>
          <th>ì‚¬ìš© ë‹¨ê°€</th>
          <th>ì¬ë£Œ ìˆ˜ëŸ‰</th>
          <th>ì¬ë£Œ ë‹¨ìœ„</th>
          <th>ì¬ë£Œ ê°€ê²©</th>
          <th>ì¬ë£Œ ë‹¨ê°€</th>
          <th>ì†Œë¶„ ìˆ˜ëŸ‰</th>
          <th>ì†Œê³„</th>
        </tr>
      </thead>
      <tbody>
  `;

  sectionData.forEach((sec, idx) => {
    const sectionId = `sec-detail-${idx}`;
    sec.ingredients.forEach((ing, i) => {
      html += `
        <tr class="${sectionId}">
          ${i === 0 ? `<td rowspan="${sec.ingredients.length}">${sec.name}</td>` : ''}
          <td>${ing.name}</td>
          <td>${ing.amount}</td>
          <td>${ing.unit}</td>
          <td>${ing.usedUnitPrice}</td>
          <td>${ing.quantity || ''}</td>
          <td>${ing.unit || ''}</td>
          <td>${ing.price || ''}</td>
          <td>${ing.unitPrice || ''}</td>
          ${i === 0 ? `<td rowspan="${sec.ingredients.length}">${sec.portionQty ?? ''}</td>` : ''}
          ${i === 0 ? `<td rowspan="${sec.ingredients.length}">${sec.subtotal}</td>` : ''}
        </tr>
      `;
    });
  });

  html += `</tbody></table>`;
  document.getElementById('recipePreview').innerHTML = html;
}

    
function openRecipeEditor(index = null) {
  // index: nullì´ë©´ ìƒˆë¡œ ì‘ì„±, ìˆ«ìë©´ ìˆ˜ì •
  const recipe = index !== null ? recipes[index] : null;

  const content = document.getElementById('content');
  content.innerHTML = `
  <div class="editor-container">
    <div class="editor-left">
      <div class="editor-header">
        <button class="btn-main" onclick="saveRecipe(${index})">ë ˆì‹œí”¼ ì €ì¥</button>
        <button class="btn-sub" onclick="openMenu('recipe')">ë“±ë¡ ì·¨ì†Œ</button>
      </div>
      <div class="editor-form">
        <label>ìš”ë¦¬ëª…</label>
        <input type="text" id="recipeName" class="editor-input" />

        <label>íŒë§¤ê°€</label>
        <input type="number" id="recipePrice" class="editor-input" />

        <label>í”Œë ˆì´íŒ… ìˆœì„œ</label>
        <textarea id="recipeSteps" class="editor-textarea" rows="3"></textarea>

        <label>ë©”ëª¨</label>
        <textarea id="recipeMemo" class="editor-textarea" rows="3"></textarea>

        <div id="recipeSections" class="section-container"></div>
        <button class="btn-sub" onclick="addRecipeSection()" style="margin-top: 1rem;">+ ë¶„ë¥˜ ì¶”ê°€</button>
      </div>
    </div>
    <div class="editor-right">
      <h3>ì„œë¥˜ ë¯¸ë¦¬ë³´ê¸°</h3>
      <div id="recipePreview" class="preview-card"></div>
    </div>
  </div>
`;

  
setTimeout(() => {
    const previewTriggerElements = document.querySelectorAll(
      '#recipeName, #recipePrice, #recipeSteps, #recipeMemo, .section-name, .portion-quantity, .ingredient-name, .ingredient-amount, .ingredient-unit'
    );

    previewTriggerElements.forEach(el => {
      el.removeEventListener('input', renderRecipePreview);
      el.removeEventListener('change', renderRecipePreview);
      el.removeEventListener('blur', renderRecipePreview);

      el.addEventListener('input', renderRecipePreview);
      el.addEventListener('change', renderRecipePreview);
      el.addEventListener('blur', renderRecipePreview);
    });

    // ìµœì´ˆ 1íšŒ ë¯¸ë¦¬ë³´ê¸° ë Œë”
    renderRecipePreview();
  }, 0); // ë˜ëŠ” 50, 100 ë“±
}

function exportPrepExcel() {
  if (preps.length === 0) {
    alert("ë‚´ë³´ë‚¼ í”„ë©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const data = [["ìš”ë¦¬ëª…", "í”„ë©"]];
  preps.forEach(p => data.push([p.name, p.text]));

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "í”„ë©ë¦¬ìŠ¤íŠ¸");
  XLSX.writeFile(wb, "í”„ë©ë¦¬ìŠ¤íŠ¸.xlsx");
}

function importPrepExcel() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = ".xlsx, .xls";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = evt => {
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

      if (!rows || rows.length < 2) {
        alert("ì—‘ì…€ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const imported = rows.slice(1);
      const duplicates = [];

      imported.forEach(([name, text]) => {
        const existingIndex = preps.findIndex(p => p.name === name);
        if (existingIndex !== -1) duplicates.push(name);
      });

      if (duplicates.length > 0) {
        const overwrite = confirm(`ì¤‘ë³µ í”„ë© ì¡´ì¬ (${duplicates.join(", ")}). ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`);
        imported.forEach(([name, text]) => {
          if (!name) return;
          const idx = preps.findIndex(p => p.name === name);
          if (idx !== -1) {
            if (overwrite) preps[idx] = { name, text };
          } else {
            preps.push({ name, text });
          }
        });
      } else {
        imported.forEach(([name, text]) => {
          if (name) preps.push({ name, text });
        });
      }

      renderPrepList();
    };
    reader.readAsArrayBuffer(file);
  };
  input.click();
}

function confirmClearPrepList() {
  showModal("í”„ë© ë¦¬ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
    preps = [];
    renderPrepList();
  });
}


function cancelClearPrepList() {
  document.getElementById('prepDeleteConfirmBox').classList.remove('show');
}

function clearPrepList() {
  preps = [];
  renderPrepList();
  cancelClearPrepList();
}
function openRecipeSelector() {
  if (recipes.length === 0) {
    alert("ë“±ë¡ëœ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const names = recipes.map((r, i) => `${i + 1}. ${r.name}`).join('\n');
  const input = prompt(`ë¶ˆëŸ¬ì˜¬ ë ˆì‹œí”¼ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n${names}`);

  const index = parseInt(input) - 1;
  if (isNaN(index) || index < 0 || index >= recipes.length) {
    alert("ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
    return;
  }

  renderConvertPreview(recipes[index]);
}

function renderConvertPreview(recipe) {
  const container = document.getElementById('convertPreview');
  if (!container) return;

  const temp = document.createElement('div');
  temp.innerHTML = `<div id="recipePreview"></div>`;
  document.body.appendChild(temp);

  renderRecipePreviewFromData(recipe);

  const html = document.getElementById('recipePreview').innerHTML;
  container.innerHTML = html;

  temp.remove();
}
function exportRecipePdf() {
  const container = document.getElementById('convertPreview');
  if (!container) {
    alert("ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const nameMatch = container.innerHTML.match(/<strong>ìš”ë¦¬ëª…:<\/strong>\s*(.*?)<\/p>/);
  const recipeName = nameMatch ? nameMatch[1].trim().replace(/[\\/:*?"<>|]/g, "_") : 'ë ˆì‹œí”¼';

  // ìŠ¤íƒ€ì¼ ì‚½ì…
  const style = document.createElement('style');
  style.innerHTML = `
    #convertPreview td, #convertPreview th {
      white-space: normal !important;
      word-break: break-word !important;
      vertical-align: top !important;
      padding: 6px !important;
      font-size: 0.9em;
    }
    #convertPreview table {
      table-layout: auto !important;
    }
    #convertPreview p {
      white-space: normal !important;
      word-break: break-word !important;
    }
  `;
  container.appendChild(style);

  const opt = {
    margin: 0.5,
    filename: `${recipeName}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(container).save().then(() => {
    style.remove();
  });
}
function showModal(message, onConfirm) {
  const modal = document.getElementById('globalModal');
  const msg = document.getElementById('modalMessage');
  const btnConfirm = document.getElementById('modalConfirmBtn');
  const btnCancel = document.getElementById('modalCancelBtn');

  msg.textContent = message;
  modal.style.display = 'flex';

  // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° í›„ ìƒˆë¡œ ë°”ì¸ë”©
  const newConfirm = () => {
    modal.style.display = 'none';
    onConfirm();
  };

  const cancel = () => {
    modal.style.display = 'none';
  };

  btnConfirm.onclick = newConfirm;
  btnCancel.onclick = cancel;
}





  </script>
  
</body>
</html>

